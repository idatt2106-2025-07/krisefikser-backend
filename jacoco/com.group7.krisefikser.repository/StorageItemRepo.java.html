<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StorageItemRepo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">krisefikser</a> &gt; <a href="index.source.html" class="el_package">com.group7.krisefikser.repository</a> &gt; <span class="el_source">StorageItemRepo.java</span></div><h1>StorageItemRepo.java</h1><pre class="source lang-java linenums">package com.group7.krisefikser.repository;

import com.group7.krisefikser.model.StorageItem;
import java.sql.PreparedStatement;
import java.sql.Statement;
import java.sql.Timestamp;
import java.time.LocalDateTime;
import java.util.Collections;
import java.util.List;
import java.util.Optional;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.dao.EmptyResultDataAccessException;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.jdbc.support.KeyHolder;
import org.springframework.stereotype.Repository;


/**
 * This class is a repository for managing storage items in the database.
 * It provides methods to get, add, update, and delete storage items.
 * It uses JdbcTemplate to interact with the database.
 */
@Repository
public class StorageItemRepo {
  private final JdbcTemplate jdbcTemplate;

  /**
   * RowMapper to map the result set to a StorageItem object.
   */
<span class="fc" id="L32">  private final RowMapper&lt;StorageItem&gt; storageItemRowMapper = (rs, rowNum) -&gt; {</span>
<span class="fc" id="L33">    return new StorageItem(</span>
<span class="fc" id="L34">      rs.getInt(&quot;id&quot;),</span>
<span class="fc" id="L35">      rs.getTimestamp(&quot;expiration_date&quot;).toLocalDateTime(),</span>
<span class="fc" id="L36">      rs.getInt(&quot;quantity&quot;),</span>
<span class="fc" id="L37">      rs.getInt(&quot;household_id&quot;),</span>
<span class="fc" id="L38">      rs.getInt(&quot;item_id&quot;)</span>
    );
  };

  /**
   * Constructor for StorageItemRepo.
   *
   * @param jdbcTemplate The JdbcTemplate used to interact with the database.
   */
  @Autowired
<span class="fc" id="L48">  public StorageItemRepo(JdbcTemplate jdbcTemplate) {</span>
<span class="fc" id="L49">    this.jdbcTemplate = jdbcTemplate;</span>
<span class="fc" id="L50">  }</span>

  /**
   * This method retrieves all storage items for a specific household from the database.
   *
   * @param householdId The ID of the household to retrieve storage items for
   * @return A list of StorageItem objects.
   */
  public List&lt;StorageItem&gt; getAllStorageItems(int householdId) {
<span class="fc" id="L59">    String sql = &quot;SELECT id, expiration_date, quantity, household_id, &quot;</span>
        + &quot;item_id FROM storage_items WHERE household_id = ?&quot;;
<span class="fc" id="L61">    return jdbcTemplate.query(sql, storageItemRowMapper, householdId);</span>
  }

  /**
   * This method retrieves a storage item by its ID for a specific household.
   *
   * @param id          The ID of the storage item to retrieve.
   * @param householdId The ID of the household the storage item belongs to.
   * @return An Optional containing the StorageItem object if found, or empty if not found.
   */
  public Optional&lt;StorageItem&gt; findById(int id, int householdId) {
    try {
<span class="fc" id="L73">      String sql = &quot;SELECT id, expiration_date, quantity, household_id, &quot;</span>
          + &quot;item_id FROM storage_items WHERE id = ? AND household_id = ?&quot;;
<span class="fc" id="L75">      StorageItem storageItem = jdbcTemplate.queryForObject(sql,</span>
<span class="fc" id="L76">          storageItemRowMapper, id, householdId);</span>
<span class="fc" id="L77">      return Optional.ofNullable(storageItem);</span>
<span class="fc" id="L78">    } catch (EmptyResultDataAccessException e) {</span>
<span class="fc" id="L79">      return Optional.empty();</span>
    }
  }

  /**
   * This method retrieves storage items by their item ID for a specific household.
   *
   * @param itemId      The item ID of the storage items to retrieve.
   * @param householdId The ID of the household the storage items belong to.
   * @return A list of StorageItem objects of the specified item.
   */
  public List&lt;StorageItem&gt; findByItemId(int itemId, int householdId) {
<span class="fc" id="L91">    String sql = &quot;SELECT id, expiration_date, quantity, household_id, item_id FROM storage_items &quot;</span>
        + &quot;WHERE item_id = ? AND household_id = ?&quot;;
<span class="fc" id="L93">    return jdbcTemplate.query(sql, storageItemRowMapper, itemId, householdId);</span>
  }

  /**
   * Adds a new storage item to the database.
   * This method inserts the storage item's details into the database and sets the generated ID
   * on the provided storageItem object.
   *
   * @param storageItem The storage item to be added. It must contain expiration date,
   *                    quantity, household ID, and item ID.
   * @return The added storage item with the generated ID set.
   */
  public StorageItem add(StorageItem storageItem) {
<span class="fc" id="L106">    String sql = &quot;INSERT INTO storage_items (expiration_date, quantity, &quot;</span>
        + &quot;household_id, item_id) VALUES (?, ?, ?, ?)&quot;;
<span class="fc" id="L108">    KeyHolder keyHolder = new GeneratedKeyHolder();</span>

<span class="fc" id="L110">    jdbcTemplate.update(connection -&gt; {</span>
<span class="fc" id="L111">      PreparedStatement ps = connection.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);</span>
<span class="fc" id="L112">      ps.setTimestamp(1, Timestamp.valueOf(storageItem.getExpirationDate()));</span>
<span class="fc" id="L113">      ps.setInt(2, storageItem.getQuantity());</span>
<span class="fc" id="L114">      ps.setInt(3, storageItem.getHouseholdId());</span>
<span class="fc" id="L115">      ps.setInt(4, storageItem.getItemId());</span>
<span class="fc" id="L116">      return ps;</span>
    }, keyHolder);

<span class="fc" id="L119">    storageItem.setId(keyHolder.getKey().intValue());</span>
<span class="fc" id="L120">    return storageItem;</span>
  }

  /**
   * Updates an existing storage item in the database.
   * Ensures the storage item belongs to the specified household.
   *
   * @param storageItem The storage item to be updated. It must contain the ID and the new details.
   * @return The updated storage item.
   * @throws EmptyResultDataAccessException if no storage item is found with the
   *        given ID in the specified household.
   */
  public StorageItem update(StorageItem storageItem) {
<span class="fc" id="L133">    String sql = &quot;UPDATE storage_items SET expiration_date = ?, quantity = ?, item_id = ? &quot;</span>
        + &quot;WHERE id = ? AND household_id = ?&quot;;
<span class="fc" id="L135">    int rowsAffected = jdbcTemplate.update(sql,</span>
<span class="fc" id="L136">        Timestamp.valueOf(storageItem.getExpirationDate()),</span>
<span class="fc" id="L137">        storageItem.getQuantity(),</span>
<span class="fc" id="L138">        storageItem.getItemId(),</span>
<span class="fc" id="L139">        storageItem.getId(),</span>
<span class="fc" id="L140">        storageItem.getHouseholdId());</span>

<span class="fc bfc" id="L142" title="All 2 branches covered.">    if (rowsAffected == 0) {</span>
<span class="fc" id="L143">      throw new EmptyResultDataAccessException(</span>
<span class="fc" id="L144">        &quot;No storage item found with id: &quot; + storageItem.getId()</span>
<span class="fc" id="L145">          + &quot; in household: &quot; + storageItem.getHouseholdId(), 1);</span>
    }
<span class="fc" id="L147">    return storageItem;</span>
  }

  /**
   * Deletes a storage item from the database by its ID,
   * ensuring it belongs to the specified household.
   *
   * @param id          The ID of the storage item to be deleted.
   * @param householdId The ID of the household the storage item belongs to.
   * @return true if the storage item was deleted, false otherwise.
   */
  public boolean deleteById(int id, int householdId) {
<span class="fc" id="L159">    String sql = &quot;DELETE FROM storage_items WHERE id = ? AND household_id = ?&quot;;</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">    return jdbcTemplate.update(sql, id, householdId) &gt; 0;</span>
  }

  /**
   * Deletes all storage items of a specific household from the database.
   *
   * @param householdId The household ID of the storage items to be deleted.
   * @return The number of storage items deleted.
   */
  public int deleteByHouseholdId(int householdId) {
<span class="fc" id="L170">    String sql = &quot;DELETE FROM storage_items WHERE household_id = ?&quot;;</span>
<span class="fc" id="L171">    return jdbcTemplate.update(sql, householdId);</span>
  }

  /**
   * Retrieves storage items that are about to expire for a specific household.
   *
   * @param days        The number of days within which items will expire.
   * @param householdId The ID of the household to retrieve expiring items for.
   * @return A list of storage items that will expire within the specified number of days.
   */
  public List&lt;StorageItem&gt; findExpiringItems(int days, int householdId) {
    // Calculate current date and future date using Java
<span class="fc" id="L183">    LocalDateTime now = LocalDateTime.now();</span>
<span class="fc" id="L184">    LocalDateTime futureDate = now.plusDays(days);</span>

<span class="fc" id="L186">    String sql = &quot;SELECT id, expiration_date, quantity, household_id, item_id FROM storage_items &quot;</span>
        + &quot;WHERE expiration_date &lt;= ? &quot;
        + &quot;AND expiration_date &gt;= ? &quot;
        + &quot;AND household_id = ?&quot;;

<span class="fc" id="L191">    return jdbcTemplate.query(sql, storageItemRowMapper,</span>
<span class="fc" id="L192">      Timestamp.valueOf(futureDate),</span>
<span class="fc" id="L193">      Timestamp.valueOf(now),</span>
<span class="fc" id="L194">      householdId);</span>
  }

  /**
   * Retrieves storage items by item type for a specific household.
   * Uses a JOIN query to filter at the database level.
   *
   * @param householdId The household ID of the storage items to retrieve.
   * @param itemTypeStrings The types of items to filter by (lowercase strings).
   * @return A list of StorageItem objects matching the criteria.
   */
  public List&lt;StorageItem&gt; findByItemTypes(int householdId, List&lt;String&gt; itemTypeStrings) {
<span class="pc bpc" id="L206" title="1 of 4 branches missed.">    if (itemTypeStrings == null || itemTypeStrings.isEmpty()) {</span>
<span class="fc" id="L207">      return getAllStorageItems(householdId);</span>
    }

<span class="fc" id="L210">    String placeholders = String.join(&quot;,&quot;, Collections.nCopies(itemTypeStrings.size(), &quot;?&quot;));</span>

<span class="fc" id="L212">    String sql = &quot;SELECT si.id, si.expiration_date, si.quantity, si.household_id, si.item_id &quot;</span>
          + &quot;FROM storage_items si &quot;
          + &quot;JOIN items i ON si.item_id = i.id &quot;
          + &quot;WHERE si.household_id = ? &quot;
          + &quot;AND i.type IN (&quot; + placeholders + &quot;)&quot;;

<span class="fc" id="L218">    Object[] params = new Object[itemTypeStrings.size() + 1];</span>
<span class="fc" id="L219">    params[0] = householdId;</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">    for (int i = 0; i &lt; itemTypeStrings.size(); i++) {</span>
<span class="fc" id="L221">      params[i + 1] = itemTypeStrings.get(i);</span>
    }

<span class="fc" id="L224">    return jdbcTemplate.query(sql, storageItemRowMapper, params);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>