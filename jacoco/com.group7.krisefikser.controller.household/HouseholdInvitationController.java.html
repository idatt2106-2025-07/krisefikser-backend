<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HouseholdInvitationController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">krisefikser</a> &gt; <a href="index.source.html" class="el_package">com.group7.krisefikser.controller.household</a> &gt; <span class="el_source">HouseholdInvitationController.java</span></div><h1>HouseholdInvitationController.java</h1><pre class="source lang-java linenums">package com.group7.krisefikser.controller.household;

import com.group7.krisefikser.dto.request.household.InvitationRequest;
import com.group7.krisefikser.exception.InvitationNotFoundException;
import com.group7.krisefikser.exception.JwtMissingPropertyException;
import com.group7.krisefikser.model.household.HouseholdInvitation;
import com.group7.krisefikser.repository.user.UserRepository;
import com.group7.krisefikser.service.household.HouseholdInvitationService;
import com.group7.krisefikser.service.user.UserService;
import com.group7.krisefikser.utils.JwtUtils;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.tags.Tag;
import java.util.Map;
import java.util.logging.Logger;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

/**
 * REST controller for managing household invitations.
 * Provides endpoints for creating and accepting invitations.
 */
@RestController
@RequiredArgsConstructor
@RequestMapping(&quot;/api/household-invitations&quot;)
@Tag(name = &quot;Household Invitation&quot;, description = &quot;API for managing household invitations&quot;)
public class HouseholdInvitationController {
  private final HouseholdInvitationService invitationService;
<span class="fc" id="L40">  private static final Logger logger = Logger</span>
<span class="fc" id="L41">      .getLogger(HouseholdInvitationController.class.getName());</span>
  private final JwtUtils jwtUtils;
  private final UserRepository userRepository;
  private final UserService userService;

  /**
   * Creates a new household invitation.
   *
   * @param request The invitation request containing email.
   * @return A ResponseEntity containing the created HouseholdInvitation object.
   */
  @PostMapping
  @Operation(summary = &quot;Create a household invitation&quot;,
      description = &quot;Creates an invitation to join a household and sends an email to the invitee&quot;)
  @ApiResponses(value = {
    @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Invitation created successfully&quot;,
      content = @Content(schema = @Schema(implementation = HouseholdInvitation.class))),
    @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid request data&quot;),
    @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Unauthorized&quot;),
    @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Internal server error&quot;)
  })
  @io.swagger.v3.oas.annotations.parameters.RequestBody(
      description = &quot;JSON object containing the email of the person to invite&quot;,
      required = true,
      content = @Content(
      mediaType = &quot;application/json&quot;,
      schema = @Schema(implementation = InvitationRequest.class)
        )
  )
  public ResponseEntity&lt;?&gt; createInvitation(@RequestBody InvitationRequest request) {
    try {
<span class="pc bpc" id="L72" title="2 of 4 branches missed.">      if (request.getEmail() == null || request.getEmail().isBlank()) {</span>
<span class="nc" id="L73">        return ResponseEntity.badRequest().body(&quot;Email must not be empty&quot;);</span>
      }

<span class="fc" id="L76">      String emailRegex =</span>
          &quot;^[a-zA-Z0-9_+&amp;*-]+(?:\\.[a-zA-Z0-9_+&amp;*-]+)*@(?:[a-zA-Z0-9-]+\\.)+[a-zA-Z]{2,7}$&quot;;
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">      if (!request.getEmail().matches(emailRegex)) {</span>
<span class="nc" id="L79">        return ResponseEntity.badRequest().body(&quot;Invalid email format&quot;);</span>
      }

<span class="fc" id="L82">      String userIdStr = SecurityContextHolder.getContext().getAuthentication().getName();</span>
<span class="fc" id="L83">      Long userId = Long.parseLong(userIdStr);</span>

<span class="fc" id="L85">      HouseholdInvitation invitation = invitationService.createInvitation(userId,</span>
<span class="fc" id="L86">          request.getEmail());</span>
<span class="fc" id="L87">      logger.info(&quot;Invitation created successfully with token: &quot; + invitation.getInvitationToken());</span>
<span class="fc" id="L88">      return ResponseEntity.ok(invitation);</span>

<span class="nc" id="L90">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L91">      logger.severe(&quot;Invalid request data: &quot; + e.getMessage());</span>
<span class="nc" id="L92">      return ResponseEntity.badRequest().body(e.getMessage());</span>

<span class="nc" id="L94">    } catch (Exception e) {</span>
<span class="nc" id="L95">      logger.severe(&quot;Unexpected error while creating invitation&quot; + e);</span>
<span class="nc" id="L96">      return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L97">        .body(&quot;An unexpected error occurred&quot;);</span>
    }
  }

  /**
   * Verifies a household invitation using a token.
   *
   * @param token The invitation token provided as a query parameter.
   * @return A ResponseEntity containing the invitation details if valid.
   */
  @GetMapping(&quot;/verify&quot;)
  @Operation(
      summary = &quot;Verify a household invitation&quot;,
      description = &quot;Verifies if an invitation token is valid and returns invitation details&quot;,
      parameters = {
        @io.swagger.v3.oas.annotations.Parameter(
          name = &quot;token&quot;,
          description = &quot;The invitation token to verify&quot;,
          required = true,
          schema = @Schema(type = &quot;string&quot;),
          in = io.swagger.v3.oas.annotations.enums.ParameterIn.QUERY
          )
      }
  )
  @ApiResponses(value = {
    @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Invitation is valid&quot;),
    @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Invitation not found or expired&quot;)
  })
  public ResponseEntity&lt;?&gt; verifyInvitation(@RequestParam String token) {
<span class="fc" id="L126">    logger.info(&quot;Verify invitation token: &quot; + token);</span>
<span class="fc" id="L127">    HouseholdInvitation invitation = invitationService.verifyInvitation(token);</span>
<span class="fc" id="L128">    return ResponseEntity.ok(invitation);</span>
  }

  /**
   * Accepts a household invitation using a token.
   *
   * @param requestBody The request body containing the invitation token.
   * @return A ResponseEntity indicating the result of the acceptance.
   */
  @PostMapping(&quot;/accept&quot;)
  @Operation(
      summary = &quot;Accept a household invitation&quot;,
      description = &quot;Accepts an invitation using the provided token&quot;
  )
  @ApiResponses(value = {
    @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Invitation accepted successfully&quot;),
    @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Missing or invalid token&quot;),
    @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Unauthorized&quot;),
    @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Invitation not found or expired&quot;),
    @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Internal server error&quot;)
  })
  @io.swagger.v3.oas.annotations.parameters.RequestBody(
      description = &quot;JSON object containing the invitation token&quot;,
      required = true,
      content = @Content(
      mediaType = &quot;application/json&quot;,
      schema = @Schema(
        type = &quot;object&quot;,
        example = &quot;{\&quot;token\&quot;: \&quot;invitation-token-value\&quot;}&quot;,
        requiredProperties = {&quot;token&quot;}
      )
      )
  )
  public ResponseEntity&lt;?&gt; acceptInvitation(@RequestBody Map&lt;String, String&gt; requestBody) {
    try {
<span class="fc" id="L163">      String token = requestBody.get(&quot;token&quot;);</span>

<span class="pc bpc" id="L165" title="3 of 4 branches missed.">      if (token == null || token.isBlank()) {</span>
<span class="fc" id="L166">        return ResponseEntity.badRequest().body(&quot;Token is required&quot;);</span>
      }

<span class="nc" id="L169">      String email = jwtUtils.validateInvitationTokenAndGetEmail(token);</span>
<span class="nc" id="L170">      Long userId = userService.getUserIdByEmail(email);</span>

<span class="nc" id="L172">      invitationService.acceptInvitation(token, userId);</span>
<span class="nc" id="L173">      logger.info(&quot;Invitation accepted successfully&quot;);</span>
<span class="nc" id="L174">      return ResponseEntity.ok().build();</span>

<span class="nc" id="L176">    } catch (NumberFormatException e) {</span>
<span class="nc" id="L177">      logger.severe(&quot;Invalid user ID in security context&quot; + e.getMessage());</span>
<span class="nc" id="L178">      return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Invalid authentication context&quot;);</span>

<span class="nc" id="L180">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L181">      logger.severe(&quot;Invalid token or user: &quot; + e.getMessage());</span>
<span class="nc" id="L182">      return ResponseEntity.badRequest().body(e.getMessage());</span>

<span class="nc" id="L184">    } catch (InvitationNotFoundException e) {</span>
<span class="nc" id="L185">      logger.severe(&quot;Invitation not found or expired: &quot; + e.getMessage());</span>
<span class="nc" id="L186">      return ResponseEntity.status(HttpStatus.NOT_FOUND).body(&quot;Invitation not found or expired&quot;);</span>

<span class="nc" id="L188">    } catch (JwtMissingPropertyException e) {</span>
<span class="nc" id="L189">      logger.severe(&quot;Missing expected property in token: &quot; + e.getMessage());</span>
<span class="nc" id="L190">      return ResponseEntity.badRequest().body(&quot;Invalid token format&quot;);</span>

<span class="nc" id="L192">    } catch (Exception e) {</span>
<span class="nc" id="L193">      logger.severe(&quot;Unexpected error while accepting invitation&quot; + e);</span>
<span class="nc" id="L194">      return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L195">        .body(&quot;An unexpected error occurred&quot;);</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>