<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ItemService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">krisefikser</a> &gt; <a href="index.source.html" class="el_package">com.group7.krisefikser.service.item</a> &gt; <span class="el_source">ItemService.java</span></div><h1>ItemService.java</h1><pre class="source lang-java linenums">package com.group7.krisefikser.service.item;

import com.group7.krisefikser.dto.request.item.ItemRequest;
import com.group7.krisefikser.dto.response.item.ItemResponse;
import com.group7.krisefikser.enums.ItemType;
import com.group7.krisefikser.model.item.Item;
import com.group7.krisefikser.repository.item.ItemRepo;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.stream.Collectors;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;


/**
 * This class is a service for managing items.
 * It provides methods to get, add, update, delete, sort and filter items.
 * It uses ItemRepo to interact with the database.
 */
@Service
@RequiredArgsConstructor
public class ItemService {
  private final ItemRepo itemRepo;

  /**
   * Retrieves all items from the repository.
   *
   * @return A list of all items available in the database.
   */
  public List&lt;Item&gt; getAllItems() {
<span class="fc" id="L32">    return itemRepo.getAllItems();</span>
  }

  /**
   * Retrieves an item by its ID.
   *
   * @param id The ID of the item to retrieve.
   * @return The item with the specified ID.
   */
  public Item getItemById(int id) {
<span class="fc" id="L42">    return itemRepo.findById(id)</span>
<span class="fc" id="L43">      .orElseThrow(() -&gt; new RuntimeException(&quot;Item not found with id: &quot; + id));</span>
  }

  /**
   * Retrieves items by their types.
   *
   * @param types A list of item types to filter by.
   * @return A list of items that match the specified types.
   */
  public List&lt;Item&gt; getItemsByTypes(List&lt;ItemType&gt; types) {
<span class="pc bpc" id="L53" title="1 of 4 branches missed.">    if (types == null || types.isEmpty()) {</span>
<span class="fc" id="L54">      return getAllItems();</span>
    }

<span class="fc" id="L57">    return getAllItems().stream()</span>
<span class="fc" id="L58">      .filter(item -&gt; types.contains(item.getType()))</span>
<span class="fc" id="L59">      .collect(Collectors.toList());</span>
  }

  /**
   * Creates a comparator based on the specified sort criteria.
   *
   * @param sortBy        The field to sort by (e.g., &quot;calories&quot; or &quot;name&quot;).
   * @param sortDirection The direction of sorting (e.g., &quot;asc&quot; or &quot;desc&quot;).
   * @return A comparator for sorting items.
   */
  private Comparator&lt;Item&gt; createComparator(String sortBy, String sortDirection) {
    Comparator&lt;Item&gt; comparator;
<span class="fc bfc" id="L71" title="All 2 branches covered.">    if (&quot;calories&quot;.equalsIgnoreCase(sortBy)) {</span>
<span class="fc" id="L72">      comparator = Comparator.comparing(Item::getCalories);</span>
    } else {
<span class="fc" id="L74">      comparator = Comparator.comparing(Item::getName, String.CASE_INSENSITIVE_ORDER);</span>
    }

<span class="fc bfc" id="L77" title="All 2 branches covered.">    return &quot;desc&quot;.equalsIgnoreCase(sortDirection) ? comparator.reversed() : comparator;</span>
  }

  /**
   * Retrieves all items sorted by the specified criteria.
   *
   * @param sortBy        The field to sort by (e.g., &quot;calories&quot; or &quot;name&quot;).
   * @param sortDirection The direction of sorting (e.g., &quot;asc&quot; or &quot;desc&quot;).
   * @return A list of sorted items.
   */
  public List&lt;Item&gt; getSortedItems(String sortBy, String sortDirection) {
<span class="fc" id="L88">    List&lt;Item&gt; items = getAllItems();</span>
<span class="fc" id="L89">    Comparator&lt;Item&gt; comparator = createComparator(sortBy, sortDirection);</span>

<span class="fc" id="L91">    return items.stream()</span>
<span class="fc" id="L92">      .sorted(comparator)</span>
<span class="fc" id="L93">      .collect(Collectors.toList());</span>
  }

  /**
   * Retrieves items filtered by types and sorted by the specified criteria.
   *
   * @param types         A list of item types to filter by.
   * @param sortBy        The field to sort by (e.g., &quot;calories&quot; or &quot;name&quot;).
   * @param sortDirection The direction of sorting (e.g., &quot;asc&quot; or &quot;desc&quot;).
   * @return A list of filtered and sorted items.
   */
  public List&lt;Item&gt; getFilteredAndSortedItems(List&lt;ItemType&gt; types,
                                              String sortBy, String sortDirection) {
    // Apply filtering if types are provided
<span class="nc bnc" id="L107" title="All 4 branches missed.">    List&lt;Item&gt; filteredItems = (types != null &amp;&amp; !types.isEmpty())</span>
<span class="nc" id="L108">        ? getItemsByTypes(types)</span>
<span class="nc" id="L109">        : getAllItems();</span>

<span class="nc" id="L111">    Comparator&lt;Item&gt; comparator = createComparator(sortBy, sortDirection);</span>

<span class="nc" id="L113">    return filteredItems.stream()</span>
<span class="nc" id="L114">      .sorted(comparator)</span>
<span class="nc" id="L115">      .collect(Collectors.toList());</span>
  }

  /**
   * Searches for items that match the given search term by name.
   * The search is case-insensitive and matches partial item names.
   *
   * @param searchTerm The term to search for in item names
   * @return A list of items that match the search term
   */
  public List&lt;Item&gt; searchItemsByName(String searchTerm) {
<span class="nc bnc" id="L126" title="All 4 branches missed.">    if (searchTerm == null || searchTerm.trim().isEmpty()) {</span>
<span class="nc" id="L127">      return getAllItems();</span>
    }

<span class="nc" id="L130">    String lowercaseSearchTerm = searchTerm.toLowerCase().trim();</span>

<span class="nc" id="L132">    return getAllItems().stream()</span>
<span class="nc" id="L133">      .filter(item -&gt; item.getName().toLowerCase().contains(lowercaseSearchTerm))</span>
<span class="nc" id="L134">      .collect(Collectors.toList());</span>
  }

  /**
   * Adds a new item to the repository after validating it.
   * This method ensures that the item meets all validation criteria
   * before delegating the addition to the repository.
   *
   * @param item The item to be added. It must contain valid name, unit, calories, and type.
   * @return The added item with its generated ID.
   */
  public Item addItem(Item item) {
<span class="fc" id="L146">    validateItem(item);</span>
<span class="fc" id="L147">    return itemRepo.add(item);</span>
  }

  /**
   * Updates an existing item in the repository after validating it.
   * This method ensures that the item meets all validation criteria
   * before delegating the update to the repository.
   *
   * @param id   The ID of the item to be updated.
   * @param item The updated item details. It must contain valid name, unit, calories, and type.
   * @return The updated item.
   */
  public Item updateItem(int id, Item item) {
<span class="fc bfc" id="L160" title="All 2 branches covered.">    if (!itemExists(id)) {</span>
<span class="fc" id="L161">      throw new RuntimeException(&quot;Item not found with id: &quot; + id);</span>
    }

<span class="fc" id="L164">    validateItem(item);</span>
<span class="fc" id="L165">    item.setId(id);</span>
<span class="fc" id="L166">    return itemRepo.update(item);</span>
  }

  /**
   * Deletes an item from the repository by its ID.
   *
   * @param id The ID of the item to be deleted.
   */
  public void deleteItem(int id) {
<span class="fc bfc" id="L175" title="All 2 branches covered.">    if (!itemExists(id)) {</span>
<span class="fc" id="L176">      throw new RuntimeException(&quot;Item not found with id: &quot; + id);</span>
    }

<span class="fc" id="L179">    itemRepo.deleteById(id);</span>
<span class="fc" id="L180">  }</span>

  /**
   * Validates the item properties before adding or updating it.
   * This method checks if the name, unit, calories, and type are valid.
   *
   * @param item The item to be validated.
   */
  private void validateItem(Item item) {
    // Name validation
<span class="fc bfc" id="L190" title="All 4 branches covered.">    if (item.getName() == null || item.getName().trim().isEmpty()) {</span>
<span class="fc" id="L191">      throw new IllegalArgumentException(&quot;Item name cannot be empty&quot;);</span>
    }

    // Unit validation
<span class="fc bfc" id="L195" title="All 4 branches covered.">    if (item.getUnit() == null || item.getUnit().trim().isEmpty()) {</span>
<span class="fc" id="L196">      throw new IllegalArgumentException(&quot;Item unit cannot be empty&quot;);</span>
    }

    // Calories validation
<span class="fc bfc" id="L200" title="All 2 branches covered.">    if (item.getCalories() &lt; 0) {</span>
<span class="fc" id="L201">      throw new IllegalArgumentException(&quot;Calories cannot be negative&quot;);</span>
    }

    // Type validation
<span class="fc bfc" id="L205" title="All 2 branches covered.">    if (item.getType() == null) {</span>
<span class="fc" id="L206">      throw new IllegalArgumentException(&quot;Item type must be specified&quot;);</span>
    }
<span class="fc" id="L208">  }</span>

  /**
   * Checks if an item exists in the repository by its ID.
   *
   * @param id The ID of the item to check.
   * @return true if the item exists, false otherwise.
   */
  public boolean itemExists(int id) {
<span class="fc" id="L217">    return itemRepo.findById(id).isPresent();</span>
  }

  /**
   * Converts a list of Item entities to ItemResponse DTOs.
   *
   * @param items The list of Item entities to convert
   * @return A list of corresponding ItemResponse objects
   */
  public List&lt;ItemResponse&gt; convertToItemResponses(List&lt;Item&gt; items) {
<span class="fc" id="L227">    return items.stream()</span>
<span class="fc" id="L228">      .map(ItemResponse::fromEntity)</span>
<span class="fc" id="L229">      .collect(Collectors.toList());</span>
  }

  /**
   * Converts a list of type strings to a list of ItemType enums.
   * Invalid type strings are ignored.
   *
   * @param typeStrings The list of type strings to convert
   * @return A list of valid ItemType enums
   */
  public List&lt;ItemType&gt; convertToItemTypes(List&lt;String&gt; typeStrings) {
<span class="fc" id="L240">    List&lt;ItemType&gt; itemTypes = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L241" title="All 4 branches covered.">    if (typeStrings != null &amp;&amp; !typeStrings.isEmpty()) {</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">      for (String typeStr : typeStrings) {</span>
        try {
<span class="fc" id="L244">          ItemType type = ItemType.fromString(typeStr);</span>
<span class="fc" id="L245">          itemTypes.add(type);</span>
<span class="fc" id="L246">        } catch (IllegalArgumentException e) {</span>
          // Skip invalid types
<span class="fc" id="L248">        }</span>
<span class="fc" id="L249">      }</span>
    }
<span class="fc" id="L251">    return itemTypes;</span>
  }

  /**
   * Adds a new item based on the provided ItemRequest.
   * This method handles the conversion from DTO to entity and back to response DTO.
   *
   * @param itemRequest The request containing the item details
   * @return The response DTO for the created item
   */
  public ItemResponse addItemFromRequest(ItemRequest itemRequest) {
<span class="fc" id="L262">    Item item = itemRequest.toEntity();</span>
<span class="fc" id="L263">    Item createdItem = addItem(item);</span>
<span class="fc" id="L264">    return ItemResponse.fromEntity(createdItem);</span>
  }

  /**
   * Updates an existing item based on the provided ItemRequest.
   * This method handles the conversion from DTO to entity and back to response DTO.
   *
   * @param id The ID of the item to update
   * @param itemRequest The request containing the updated item details
   * @return The response DTO for the updated item
   */
  public ItemResponse updateItemFromRequest(int id, ItemRequest itemRequest) {
<span class="fc" id="L276">    Item item = itemRequest.toEntity(id);</span>
<span class="fc" id="L277">    Item updatedItem = updateItem(id, item);</span>
<span class="fc" id="L278">    return ItemResponse.fromEntity(updatedItem);</span>
  }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>